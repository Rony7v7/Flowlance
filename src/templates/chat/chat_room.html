{% extends "navigation/navigation.html" %}
{% load i18n %}

{% block app_content %}
<div class="flex h-screen bg-bg_white text-primary_black">
    {% include "chat/chat_contacts.html" %}

    <div class="flex-1 flex flex-col">
        <div class="h-16 border-b border-primary_lightest flex items-center px-6 bg-bg_gray">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-primary_medium rounded-full flex items-center justify-center text-bg_white font-semibold">
                    {{ member.username|slice:":2"|upper }}
                </div>
                <h2 class="ml-3 text-lg font-semibold text-primary_dark">Chat con {{ member.username }}</h2>
            </div>
            <button id="clear-chat" class="bg-red-500 text-white px-2 py-2 rounded-lg ml-auto">
                Borrar chat
            </button>
        </div>

        <div class="flex-1 flex flex-col">
            <div id="chat-log" class="flex-1 overflow-y-auto p-6 space-y-4" style="max-height: calc(100vh - 160px);">
                {% for message in messages %}
                <div class="flex {% if message.sender == request.user %}justify-end{% endif %}">
                    <div class="max-w-[70%] {% if message.sender == request.user %}bg-primary_medium text-bg_white{% else %}bg-bg_gray text-primary_black{% endif %} rounded-lg px-4 py-2">
                        <div class="flex items-center {% if message.sender == request.user %}justify-end{% endif %} mb-1">
                            <span class="font-semibold text-sm">{{ message.sender.username }}</span>
                            <span class="text-xs text-primary_light ml-2">{{ message.timestamp|time:"g:i A" }}</span>
                        </div>
                        {% if message.content %}
                        <p class="text-sm">{{ message.content }}</p>
                        {% endif %}
                        {% if message.file %}
                        <p class="text-sm"><a href="{{ message.file.url }}" target="_blank">Archivo adjunto</a></p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="border-t border-primary_lightest p-4 bg-bg_gray">
                <div class="flex items-center space-x-2">
                    <textarea 
                        id="chat-message-input"
                        class="flex-1 bg-bg_white text-primary_black rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary_medium"
                        rows="2"
                        placeholder="Escribe un mensaje..."
                    ></textarea>
                    <input type="file" id="chat-file-input" class="hidden">
                    <label for="chat-file-input" class="bg-primary_dark hover:bg-primary_medium text-bg_white px-4 py-2 rounded-lg cursor-pointer">Adjuntar archivo</label>
                    <button id="chat-message-submit" class="bg-primary_dark hover:bg-primary_medium text-bg_white px-6 py-3 rounded-lg transition-colors">
                        Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const project_id = "{{ project.id }}";
    const sender_id = "{{ request.user.id }}";
    const recipient_id = "{{ member.id }}";
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + project_id + '_' + recipient_id + '/');

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const chatLog = document.getElementById('chat-log');
        const newMessageDiv = document.createElement("div");
        const isCurrentUser = data.user === "{{ request.user.username }}";
        
        newMessageDiv.className = `flex ${isCurrentUser ? 'justify-end' : ''} mb-4`;
        newMessageDiv.innerHTML = `
            <div class="max-w-[70%] ${isCurrentUser ? 'bg-primary_medium text-bg_white' : 'bg-bg_gray text-primary_black'} rounded-lg px-4 py-2">
                <div class="flex items-center ${isCurrentUser ? 'justify-end' : ''} mb-1">
                    <span class="font-semibold text-sm">${data.user}</span>
                    <span class="text-xs text-primary_light ml-2">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
                <p class="text-sm">${data.message}</p>
                ${data.file_url ? `<p class="text-sm"><a href="${data.file_url}" target="_blank">Archivo adjunto</a></p>` : ""}
            </div>
        `;
        
        chatLog.appendChild(newMessageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    document.getElementById('chat-message-submit').onclick = async function () {
    const messageInput = document.getElementById('chat-message-input');
    const message = messageInput.value;
    const fileInput = document.getElementById('chat-file-input');
    const file = fileInput.files[0];

    if (file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('message', message);
        formData.append('project_id', project_id);
        formData.append('sender_id', sender_id);  // Asegúrate de que esto esté incluido
        formData.append('recipient_id', recipient_id);

        const response = await fetch('/chat/upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            chatSocket.send(JSON.stringify({
                'project_id': project_id,
                'sender_id': sender_id,  // Asegúrate de que esto esté incluido
                'recipient_id': recipient_id,
                'message': data.message,
                'file_url': data.file_url
            }));
        }
    } else {
        chatSocket.send(JSON.stringify({
            'project_id': project_id,
            'sender_id': sender_id,  // Asegúrate de que esto esté incluido
            'recipient_id': recipient_id,
            'message': message
        }));
    }
    
    messageInput.value = '';
    fileInput.value = '';
};

</script>
{% endblock %}
